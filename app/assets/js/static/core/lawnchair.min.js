var Lawnchair=function(){if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0){var callback=typeof arguments[0]=="function"?arguments[0]:arguments[1],options=typeof arguments[0]=="function"?{}:arguments[0];if(typeof callback!="function")throw"No callback was provided";var self=this instanceof Lawnchair?this:new Lawnchair(options,callback);self.record=options.record||"record",self.name=options.name||"records";var adapter;if(options.adapter)adapter=Lawnchair.adapters[self.indexOf(Lawnchair.adapters,options.adapter)],adapter=adapter.valid()?adapter:undefined;else for(var i=0,l=Lawnchair.adapters.length;i<l;i++){adapter=Lawnchair.adapters[i].valid()?Lawnchair.adapters[i]:undefined;if(adapter)break}if(!adapter)throw"No valid adapter.";for(var j in adapter)self[j]=adapter[j];for(var i=0,l=Lawnchair.plugins.length;i<l;i++)Lawnchair.plugins[i].call(self);return self.init(options,callback),self}throw"Incorrect # of ctor args!"};Lawnchair.adapters=[],Lawnchair.adapter=function(id,obj){obj.adapter=id;var implementing="adapter valid init keys save batch get exists all remove nuke".split(" "),indexOf=this.prototype.indexOf;for(var i in obj)if(indexOf(implementing,i)===-1)throw"Invalid adapter! Nonstandard method: "+i;return Lawnchair.adapters.push(obj),obj},Lawnchair.plugins=[],Lawnchair.plugin=function(obj){for(var i in obj)i==="init"?Lawnchair.plugins.push(obj[i]):this.prototype[i]=obj[i]},Lawnchair.prototype={isArray:Array.isArray||function(o){return Object.prototype.toString.call(o)==="[object Array]"},indexOf:function(ary,item,i,l){if(ary.indexOf)return ary.indexOf(item);for(i=0,l=ary.length;i<l;i++)if(ary[i]===item)return i;return-1},lambda:function(callback){return this.fn(this.record,callback)},fn:function(name,callback){return typeof callback=="string"?new Function(name,callback):callback},uuid:function(){var S4=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()},each:function(callback){var cb=this.lambda(callback);if(this.__results)for(var i=0,l=this.__results.length;i<l;i++)cb.call(this,this.__results[i],i);else this.all(function(r){for(var i=0,l=r.length;i<l;i++)cb.call(this,r[i],i)});return this}},window.LawnchairDOM=Lawnchair.adapter("dom",{valid:function(){return!!window.Storage},init:function(options,callback){this.storage=window.localStorage;var self=this;this.indexer={key:self.name+"._index_",all:function(){var a=JSON.parse(self.storage.getItem(this.key));return a==null&&self.storage.setItem(this.key,JSON.stringify([])),JSON.parse(self.storage.getItem(this.key))},add:function(key){var a=this.all();a.push(key),self.storage.setItem(this.key,JSON.stringify(a))},del:function(key){var a=this.all(),r=[];for(var i=0,l=a.length;i<l;i++)a[i]!=key&&r.push(a[i]);self.storage.setItem(this.key,JSON.stringify(r))},find:function(key){var a=this.all();for(var i=0,l=a.length;i<l;i++)if(key===a[i])return i;return!1}},callback&&this.fn(this.name,callback).call(this,this)},save:function(obj,callback){var key=obj.key||this.uuid();return this.indexer.find(key)||this.indexer.add(key),delete obj.key,this.storage.setItem(key,JSON.stringify(obj)),callback&&(obj.key=key,this.lambda(callback).call(this,obj)),this},batch:function(ary,callback){var saved=[];for(var i=0,l=ary.length;i<l;i++)this.save(ary[i],function(r){saved.push(r)});return callback&&this.lambda(callback).call(this,saved),this},keys:function(){var limit=options.limit||null,offset=options.offset||0;callback&&this.lambda(callback).call(this,this.indexer.all())},get:function(key,callback){if(this.isArray(key)){var r=[];for(var i=0,l=key.length;i<l;i++){var obj=JSON.parse(this.storage.getItem(key[i]));obj&&(obj.key=key[i],r.push(obj))}callback&&this.lambda(callback).call(this,r)}else{var obj=JSON.parse(this.storage.getItem(key));obj&&(obj.key=key),callback&&this.lambda(callback).call(this,obj)}return this},all:function(callback){var idx=this.indexer.all(),r=[],o;for(var i=0,l=idx.length;i<l;i++)o=JSON.parse(this.storage.getItem(idx[i])),o.key=idx[i],r.push(o);return callback&&this.fn(this.name,callback).call(this,r),this},remove:function(keyOrObj,callback){var key=typeof keyOrObj=="string"?keyOrObj:keyOrObj.key;return this.indexer.del(key),this.storage.removeItem(key),callback&&this.lambda(callback).call(this),this},nuke:function(callback){return this.all(function(r){for(var i=0,l=r.length;i<l;i++)this.remove(r[i]);callback&&this.lambda(callback).call(this)}),this}}),window.LawnchairWindowName=Lawnchair.adapter("window-name",function(index,store){var data=window.top.name?JSON.parse(window.top.name):{};return{valid:function(){return typeof window.top.name!="undefined"},init:function(options,callback){data[this.name]={index:[],store:{}},index=data[this.name].index,store=data[this.name].store,this.fn(this.name,callback).call(this,this)},keys:function(callback){return this.fn("keys",callback).call(this,index),this},save:function(obj,cb){var key=obj.key||this.uuid();return obj.key&&delete obj.key,this.exists(key,function(exists){exists||index.push(key),store[key]=obj,window.top.name=JSON.stringify(data),cb&&(obj.key=key,this.lambda(cb).call(this,obj))}),this},batch:function(objs,cb){var r=[];for(var i=0,l=objs.length;i<l;i++)this.save(objs[i],function(record){r.push(record)});return cb&&this.lambda(cb).call(this,r),this},get:function(keyOrArray,cb){var r;if(this.isArray(keyOrArray)){r=[];for(var i=0,l=keyOrArray.length;i<l;i++)r.push(store[keyOrArray[i]])}else r=store[keyOrArray],r&&(r.key=keyOrArray);return cb&&this.lambda(cb).call(this,r),this},exists:function(key,cb){return this.lambda(cb).call(this,!!store[key]),this},all:function(cb){var r=[];for(var i=0,l=index.length;i<l;i++){var obj=store[index[i]];obj.key=index[i],r.push(obj)}return this.fn(this.name,cb).call(this,r),this},remove:function(keyOrArray,cb){var del=this.isArray(keyOrArray)?keyOrArray:[keyOrArray];for(var i=0,l=del.length;i<l;i++)delete store[del[i]],index.splice(this.indexOf(index,del[i]),1);return window.top.name=JSON.stringify(data),cb&&this.lambda(cb).call(this),this},nuke:function(cb){return storage={},index=[],window.top.name=JSON.stringify(data),cb&&this.lambda(cb).call(this),this}}}()),window.LawnchairIndexedDB=Lawnchair.adapter("indexed-db",function(){function fail(e,i){console.log("error in indexed-db adapter!",e,i);debugger}function getIDB(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB}return{valid:function(){return!!getIDB()},init:function(options,callback){this.idb=getIDB(),this.waiting=[];var request=this.idb.open(this.name),self=this,cb=self.fn(self.name,callback),win=function(){return cb.call(self,self)};request.onsuccess=function(event){self.db=request.result;if(self.db.version!="1.0"){var setVrequest=self.db.setVersion("1.0");setVrequest.onsuccess=function(e){self.store=self.db.createObjectStore("teststore",{autoIncrement:!0});for(var i=0;i<self.waiting.length;i++)self.waiting[i].call(self);self.waiting=[],win()},setVrequest.onerror=function(e){console.log("Failed to create objectstore "+e),fail(e)}}else{self.store={};for(var i=0;i<self.waiting.length;i++)self.waiting[i].call(self);self.waiting=[],win()}},request.onerror=fail},save:function(obj,callback){if(!this.store){this.waiting.push(function(){this.save(obj,callback)});return}var self=this,win=function(e){callback&&(obj.key=e.target.result,self.lambda(callback).call(self,obj))},trans=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE,0),store=trans.objectStore("teststore"),request=obj.key?store.put(obj,obj.key):store.put(obj);return request.onsuccess=win,request.onerror=fail,this},batch:function(objs,cb){var results=[],done=!1,self=this,updateProgress=function(obj){results.push(obj),done=results.length===objs.length},checkProgress=setInterval(function(){done&&(cb&&self.lambda(cb).call(self,results),clearInterval(checkProgress))},200);for(var i=0,l=objs.length;i<l;i++)this.save(objs[i],updateProgress);return this},get:function(key,callback){if(!this.store){this.waiting.push(function(){this.get(key,callback)});return}var self=this,win=function(e){callback&&self.lambda(callback).call(self,e.target.result)};if(!this.isArray(key)){var req=this.db.transaction("teststore").objectStore("teststore").get(key);req.onsuccess=win,req.onerror=function(event){console.log("Failed to find "+key),fail(event)}}else{var results=[],done=!1,keys=key,updateProgress=function(obj){results.push(obj),done=results.length===keys.length},checkProgress=setInterval(function(){done&&(callback&&self.lambda(callback).call(self,results),clearInterval(checkProgress))},200);for(var i=0,l=keys.length;i<l;i++)this.get(keys[i],updateProgress)}return this},all:function(callback){if(!this.store){this.waiting.push(function(){this.all(callback)});return}var cb=this.fn(this.name,callback)||undefined,self=this,objectStore=this.db.transaction("teststore").objectStore("teststore"),toReturn=[];return objectStore.openCursor().onsuccess=function(event){var cursor=event.target.result;cursor?(toReturn.push(cursor.value),cursor.continue()):cb&&cb.call(self,toReturn)},this},remove:function(keyOrObj,callback){if(!this.store){this.waiting.push(function(){this.remove(keyOrObj,callback)});return}typeof keyOrObj=="object"&&(keyOrObj=keyOrObj.key);var self=this,win=function(){callback&&self.lambda(callback).call(self)},request=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").delete(keyOrObj);return request.onsuccess=win,request.onerror=fail,this},nuke:function(callback){if(!this.store){this.waiting.push(function(){this.nuke(callback)});return}var self=this,win=callback?function(){self.lambda(callback).call(self)}:function(){};try{this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").clear().onsuccess=win}catch(e){fail()}return this}}}()),window.LawnchairWebkitSQLite=Lawnchair.adapter("webkit-sqlite",function(){var fail=function(e,i){console.log("error in sqlite adaptor!",e,i)},now=function(){return new Date};return Function.prototype.bind||(Function.prototype.bind=function(obj){var slice=[].slice,args=slice.call(arguments,1),self=this,nop=function(){},bound=function(){return self.apply(this instanceof nop?this:obj||{},args.concat(slice.call(arguments)))};return nop.prototype=self.prototype,bound.prototype=new nop,bound}),{valid:function(){return!!window.openDatabase},init:function(options,callback){var that=this,cb=that.fn(that.name,callback),create="CREATE TABLE IF NOT EXISTS "+this.name+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",win=function(){return cb.call(that,that)};this.db=openDatabase(this.name,"1.0.0",this.name,65536),this.db.transaction(function(t){t.executeSql(create,[],win,fail)})},keys:function(callback){var cb=this.lambda(callback),that=this,keys="SELECT id FROM "+this.name+" ORDER BY timestamp DESC";return this.db.transaction(function(t){var win=function(xxx,results){if(results.rows.length==0)cb.call(that,[]);else{var r=[];for(var i=0,l=results.rows.length;i<l;i++)r.push(results.rows.item(i).id);cb.call(that,r)}};t.executeSql(keys,[],win,fail)}),this},save:function(obj,callback){var that=this,id=obj.key||that.uuid(),ins="INSERT INTO "+this.name+" (value, timestamp, id) VALUES (?,?,?)",up="UPDATE "+this.name+" SET value=?, timestamp=? WHERE id=?",win=function(){callback&&(obj.key=id,that.lambda(callback).call(that,obj))},val=[now(),id];return that.exists(obj.key,function(exists){that.db.transaction(function(t){var insert=function(obj){val.unshift(JSON.stringify(obj)),t.executeSql(ins,val,win,fail)},update=function(obj){delete obj.key,val.unshift(JSON.stringify(obj)),t.executeSql(up,val,win,fail)};exists?update(obj):insert(obj)})}),this},batch:function(objs,cb){var results=[],done=!1,that=this,updateProgress=function(obj){results.push(obj),done=results.length===objs.length},checkProgress=setInterval(function(){done&&(cb&&that.lambda(cb).call(that,results),clearInterval(checkProgress))},200);for(var i=0,l=objs.length;i<l;i++)this.save(objs[i],updateProgress);return this},get:function(keyOrArray,cb){var that=this,sql="";this.isArray(keyOrArray)?sql="SELECT id, value FROM "+this.name+" WHERE id IN ('"+keyOrArray.join("','")+"')":sql="SELECT id, value FROM "+this.name+" WHERE id = '"+keyOrArray+"'";var win=function(xxx,results){var o=null,r=[];if(results.rows.length)for(var i=0,l=results.rows.length;i<l;i++)o=JSON.parse(results.rows.item(i).value),o.key=results.rows.item(i).id,r.push(o);that.isArray(keyOrArray)||(r=r.length?r[0]:null),cb&&that.lambda(cb).call(that,r)};return this.db.transaction(function(t){t.executeSql(sql,[],win,fail)}),this},exists:function(key,cb){var is="SELECT * FROM "+this.name+" WHERE id = ?",that=this,win=function(xxx,results){cb&&that.fn("exists",cb).call(that,results.rows.length>0)};return this.db.transaction(function(t){t.executeSql(is,[key],win,fail)}),this},all:function(callback){var that=this,all="SELECT * FROM "+this.name,r=[],cb=this.fn(this.name,callback)||undefined,win=function(xxx,results){if(results.rows.length!=0)for(var i=0,l=results.rows.length;i<l;i++){var obj=JSON.parse(results.rows.item(i).value);obj.key=results.rows.item(i).id,r.push(obj)}cb&&cb.call(that,r)};return this.db.transaction(function(t){t.executeSql(all,[],win,fail)}),this},remove:function(keyOrObj,cb){var that=this,key=typeof keyOrObj=="string"?keyOrObj:keyOrObj.key,del="DELETE FROM "+this.name+" WHERE id = ?",win=function(){cb&&that.lambda(cb).call(that)};return this.db.transaction(function(t){t.executeSql(del,[key],win,fail)}),this},nuke:function(cb){var nuke="DELETE FROM "+this.name,that=this,win=cb?function(){that.lambda(cb).call(that)}:function(){};return this.db.transaction(function(t){t.executeSql(nuke,[],win,fail)}),this}}}()),window.LawnchairIEUserdata=Lawnchair.adapter("ie-userdata",{valid:function(){return typeof document.body.addBehavior!="undefined"},init:function(){var s=document.createElement("span");s.style.behavior="url('#default#userData')",s.style.position="absolute",s.style.left=1e4,document.body.appendChild(s),this.storage=s,this.storage.load("lawnchair")},get:function(key,callback){var obj=JSON.parse(this.storage.getAttribute(key)||"null");obj&&(obj.key=key),callback&&callback(obj)},save:function(obj,callback){var id=obj.key||"lc"+this.uuid();delete obj.key,this.storage.setAttribute(id,JSON.stringify(obj)),this.storage.save("lawnchair"),callback&&(obj.key=id,callback(obj))},all:function(callback){var cb=this.terseToVerboseCallback(callback),ca=this.storage.XMLDocument.firstChild.attributes,yar=[],v,o;for(var i=0,l=ca.length;i<l;i++)v=ca[i],o=JSON.parse(v.nodeValue||"null"),o&&(o.key=v.nodeName,yar.push(o));cb&&cb(yar)},remove:function(keyOrObj,callback){var key=typeof keyOrObj=="string"?keyOrObj:keyOrObj.key;this.storage.removeAttribute(key),this.storage.save("lawnchair"),callback&&callback()},nuke:function(callback){var that=this;this.all(function(r){for(var i=0,l=r.length;i<l;i++)r[i].key&&that.remove(r[i].key);callback&&callback()})}}),Lawnchair.plugin({count:function(property,callback){[].slice.call(arguments).length===1&&(callback=property,property="key");var c=0;this.each(function(e){e[property]&&c++}),this.fn("count",callback).call(this,c)},sum:function(property,callback){var sum=0;this.each(function(e){e[property]&&(sum+=e[property])}),this.fn("sum",callback).call(this,sum)},avg:function(property,callback){this.sum(property,function(sum){this.count(property,function(count){this.fn("avg",callback).call(this,sum/count)})})},min:function(property,callback){this._minOrMax("min",property,callback)},max:function(property,callback){this._minOrMax("max",property,callback)},_minOrMax:function(m,p,c){var r,all;this.all(function(a){all=a.map(function(e){return e[p]}),r=Math[m].apply(Math,all)}),this.fn(m,c).call(this,r)}}),Lawnchair.plugin(function(){var methods="save batch get remove nuke".split(" "),registry={before:{},after:{}};for(var i=0,l=methods.length;i<l;i++)registry.before[methods[i]]=[],registry.after[methods[i]]=[];return{init:function(){for(var i=0,l=methods.length;i<l;i++)this.evented(methods[i])},evented:function(methodName){var oldy=this[methodName],self=this;this[methodName]=function(){var args=[].slice.call(arguments),beforeObj=args[0],oldCallback=args[args.length-1],overwroteCallback=!1;this.fire("before",methodName,beforeObj),typeof oldCallback=="function"&&(args[args.length-1]=function(record){oldCallback.call(self,record),self.fire("after",methodName,record)},overwroteCallback=!0),oldy.apply(self,args),overwroteCallback||self.fire("after",methodName,beforeObj)}},fire:function(when,methodName,record){var callbacks=registry[when][methodName];for(var i=0,l=callbacks.length;i<l;i++)callbacks[i].call(this,record)},clearBefore:function(methodName){registry.before[methodName]=[]},clearAfter:function(methodName){registry.after[methodName]=[]},before:function(methodName,callback){registry.before[methodName].push(callback)},after:function(methodName,callback){registry.after[methodName].push(callback)}}}()),Lawnchair.plugin({page:function(page,callback){var objs=[],count=5,cur=~~page||1,next=cur+1,prev=cur-1,start=cur==1?0:prev*count,end=start>=count?start+count:count;this.all(function(r){objs=r});var max=Math.ceil(objs.length/count),page={max:max,next:next>max?max:next,prev:prev==0?1:prev};return this.__results=page[this.name]=objs.slice(start,end),callback&&this.fn("page",callback).call(this,page),this}}),Lawnchair.plugin(function(){var interpolate=function(template,args){var parts=template.split("?").filter(function(i){return i!=""}),query="";for(var i=0,l=parts.length;i<l;i++)query+=parts[i]+args[i];return query},sorter=function(p){return function(a,b){return a[p]<b[p]?-1:a[p]>b[p]?1:0}};return{where:function(){var args=[].slice.call(arguments),tmpl=args.shift(),last=args[args.length-1],qs=tmpl.match(/\?/g),q=qs&&qs.length>0?interpolate(tmpl,args.slice(0,qs.length)):tmpl,is=new Function(this.record,"return !!("+q+")"),r=[],cb;return this.all(function(all){for(var i=0,l=all.length;i<l;i++)is(all[i])&&r.push(all[i])}),this.__results=r,args.length===1&&this.fn(this.name,last).call(this,this.__results),this},asc:function(property,callback){return this.fn(this.name,callback).call(this,this.__results.sort(sorter(property))),this},desc:function(property,callback){return this.fn(this.name,callback).call(this,this.__results.sort(sorter(property)).reverse()),this}}}());