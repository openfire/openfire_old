var Lawnchair=function(){if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0){var e=typeof arguments[0]=="function"?arguments[0]:arguments[1],t=typeof arguments[0]=="function"?{}:arguments[0];if(typeof e!="function")throw"No callback was provided";var n=this instanceof Lawnchair?this:new Lawnchair(t,e);n.record=t.record||"record",n.name=t.name||"records";var r;if(t.adapter)r=Lawnchair.adapters[n.indexOf(Lawnchair.adapters,t.adapter)],r=r.valid()?r:undefined;else for(var i=0,s=Lawnchair.adapters.length;i<s;i++){r=Lawnchair.adapters[i].valid()?Lawnchair.adapters[i]:undefined;if(r)break}if(!r)throw"No valid adapter.";for(var o in r)n[o]=r[o];for(var i=0,s=Lawnchair.plugins.length;i<s;i++)Lawnchair.plugins[i].call(n);return n.init(t,e),n}throw"Incorrect # of ctor args!"};Lawnchair.adapters=[],Lawnchair.adapter=function(e,t){t.adapter=e;var n="adapter valid init keys save batch get exists all remove nuke".split(" "),r=this.prototype.indexOf;for(var i in t)if(r(n,i)===-1)throw"Invalid adapter! Nonstandard method: "+i;return Lawnchair.adapters.push(t),t},Lawnchair.plugins=[],Lawnchair.plugin=function(e){for(var t in e)t==="init"?Lawnchair.plugins.push(e[t]):this.prototype[t]=e[t]},Lawnchair.prototype={isArray:Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"},indexOf:function(e,t,n,r){if(e.indexOf)return e.indexOf(t);for(n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},lambda:function(e){return this.fn(this.record,e)},fn:function(e,t){return typeof t=="string"?new Function(e,t):t},uuid:function(){var e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},each:function(e){var t=this.lambda(e);if(this.__results)for(var n=0,r=this.__results.length;n<r;n++)t.call(this,this.__results[n],n);else this.all(function(e){for(var n=0,r=e.length;n<r;n++)t.call(this,e[n],n)});return this}},window.LawnchairDOM=Lawnchair.adapter("dom",{valid:function(){return!!window.Storage},init:function(e,t){this.storage=window.localStorage;var n=this;this.indexer={key:n.name+"._index_",all:function(){var e=JSON.parse(n.storage.getItem(this.key));return e==null&&n.storage.setItem(this.key,JSON.stringify([])),JSON.parse(n.storage.getItem(this.key))},add:function(e){var t=this.all();t.push(e),n.storage.setItem(this.key,JSON.stringify(t))},del:function(e){var t=this.all(),r=[];for(var i=0,s=t.length;i<s;i++)t[i]!=e&&r.push(t[i]);n.storage.setItem(this.key,JSON.stringify(r))},find:function(e){var t=this.all();for(var n=0,r=t.length;n<r;n++)if(e===t[n])return n;return!1}},t&&this.fn(this.name,t).call(this,this)},save:function(e,t){var n=e.key||this.uuid();return this.indexer.find(n)||this.indexer.add(n),delete e.key,this.storage.setItem(n,JSON.stringify(e)),t&&(e.key=n,this.lambda(t).call(this,e)),this},batch:function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++)this.save(e[r],function(e){n.push(e)});return t&&this.lambda(t).call(this,n),this},keys:function(){var e=options.limit||null,t=options.offset||0;callback&&this.lambda(callback).call(this,this.indexer.all())},get:function(e,t){if(this.isArray(e)){var n=[];for(var r=0,i=e.length;r<i;r++){var s=JSON.parse(this.storage.getItem(e[r]));s&&(s.key=e[r],n.push(s))}t&&this.lambda(t).call(this,n)}else{var s=JSON.parse(this.storage.getItem(e));s&&(s.key=e),t&&this.lambda(t).call(this,s)}return this},all:function(e){var t=this.indexer.all(),n=[],r;for(var i=0,s=t.length;i<s;i++)r=JSON.parse(this.storage.getItem(t[i])),r.key=t[i],n.push(r);return e&&this.fn(this.name,e).call(this,n),this},remove:function(e,t){var n=typeof e=="string"?e:e.key;return this.indexer.del(n),this.storage.removeItem(n),t&&this.lambda(t).call(this),this},nuke:function(e){return this.all(function(t){for(var n=0,r=t.length;n<r;n++)this.remove(t[n]);e&&this.lambda(e).call(this)}),this}}),window.LawnchairWindowName=Lawnchair.adapter("window-name",function(e,t){var n=window.top.name?JSON.parse(window.top.name):{};return{valid:function(){return typeof window.top.name!="undefined"},init:function(r,i){n[this.name]={index:[],store:{}},e=n[this.name].index,t=n[this.name].store,this.fn(this.name,i).call(this,this)},keys:function(t){return this.fn("keys",t).call(this,e),this},save:function(r,i){var s=r.key||this.uuid();return r.key&&delete r.key,this.exists(s,function(o){o||e.push(s),t[s]=r,window.top.name=JSON.stringify(n),i&&(r.key=s,this.lambda(i).call(this,r))}),this},batch:function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++)this.save(e[r],function(e){n.push(e)});return t&&this.lambda(t).call(this,n),this},get:function(e,n){var r;if(this.isArray(e)){r=[];for(var i=0,s=e.length;i<s;i++)r.push(t[e[i]])}else r=t[e],r&&(r.key=e);return n&&this.lambda(n).call(this,r),this},exists:function(e,n){return this.lambda(n).call(this,!!t[e]),this},all:function(n){var r=[];for(var i=0,s=e.length;i<s;i++){var o=t[e[i]];o.key=e[i],r.push(o)}return this.fn(this.name,n).call(this,r),this},remove:function(r,i){var s=this.isArray(r)?r:[r];for(var o=0,u=s.length;o<u;o++)delete t[s[o]],e.splice(this.indexOf(e,s[o]),1);return window.top.name=JSON.stringify(n),i&&this.lambda(i).call(this),this},nuke:function(t){return storage={},e=[],window.top.name=JSON.stringify(n),t&&this.lambda(t).call(this),this}}}()),window.LawnchairIndexedDB=Lawnchair.adapter("indexed-db",function(){function e(e,t){console.log("error in indexed-db adapter!",e,t);debugger}function t(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB}return{valid:function(){return!!t()},init:function(n,r){this.idb=t(),this.waiting=[];var i=this.idb.open(this.name),s=this,o=s.fn(s.name,r),u=function(){return o.call(s,s)};i.onsuccess=function(t){s.db=i.result;if(s.db.version!="1.0"){var n=s.db.setVersion("1.0");n.onsuccess=function(e){s.store=s.db.createObjectStore("teststore",{autoIncrement:!0});for(var t=0;t<s.waiting.length;t++)s.waiting[t].call(s);s.waiting=[],u()},n.onerror=function(t){console.log("Failed to create objectstore "+t),e(t)}}else{s.store={};for(var r=0;r<s.waiting.length;r++)s.waiting[r].call(s);s.waiting=[],u()}},i.onerror=e},save:function(t,n){if(!this.store){this.waiting.push(function(){this.save(t,n)});return}var r=this,i=function(e){n&&(t.key=e.target.result,r.lambda(n).call(r,t))},s=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE,0),o=s.objectStore("teststore"),u=t.key?o.put(t,t.key):o.put(t);return u.onsuccess=i,u.onerror=e,this},batch:function(e,t){var n=[],r=!1,i=this,s=function(t){n.push(t),r=n.length===e.length},o=setInterval(function(){r&&(t&&i.lambda(t).call(i,n),clearInterval(o))},200);for(var u=0,a=e.length;u<a;u++)this.save(e[u],s);return this},get:function(t,n){if(!this.store){this.waiting.push(function(){this.get(t,n)});return}var r=this,i=function(e){n&&r.lambda(n).call(r,e.target.result)};if(!this.isArray(t)){var s=this.db.transaction("teststore").objectStore("teststore").get(t);s.onsuccess=i,s.onerror=function(n){console.log("Failed to find "+t),e(n)}}else{var o=[],u=!1,a=t,f=function(e){o.push(e),u=o.length===a.length},l=setInterval(function(){u&&(n&&r.lambda(n).call(r,o),clearInterval(l))},200);for(var c=0,h=a.length;c<h;c++)this.get(a[c],f)}return this},all:function(e){if(!this.store){this.waiting.push(function(){this.all(e)});return}var t=this.fn(this.name,e)||undefined,n=this,r=this.db.transaction("teststore").objectStore("teststore"),i=[];return r.openCursor().onsuccess=function(e){var r=e.target.result;r?(i.push(r.value),r.continue()):t&&t.call(n,i)},this},remove:function(t,n){if(!this.store){this.waiting.push(function(){this.remove(t,n)});return}typeof t=="object"&&(t=t.key);var r=this,i=function(){n&&r.lambda(n).call(r)},s=this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").delete(t);return s.onsuccess=i,s.onerror=e,this},nuke:function(t){if(!this.store){this.waiting.push(function(){this.nuke(t)});return}var n=this,r=t?function(){n.lambda(t).call(n)}:function(){};try{this.db.transaction(["teststore"],webkitIDBTransaction.READ_WRITE).objectStore("teststore").clear().onsuccess=r}catch(i){e()}return this}}}()),window.LawnchairWebkitSQLite=Lawnchair.adapter("webkit-sqlite",function(){var e=function(e,t){console.log("error in sqlite adaptor!",e,t)},t=function(){return new Date};return Function.prototype.bind||(Function.prototype.bind=function(e){var t=[].slice,n=t.call(arguments,1),r=this,i=function(){},s=function(){return r.apply(this instanceof i?this:e||{},n.concat(t.call(arguments)))};return i.prototype=r.prototype,s.prototype=new i,s}),{valid:function(){return!!window.openDatabase},init:function(t,n){var r=this,i=r.fn(r.name,n),s="CREATE TABLE IF NOT EXISTS "+this.name+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",o=function(){return i.call(r,r)};this.db=openDatabase(this.name,"1.0.0",this.name,65536),this.db.transaction(function(t){t.executeSql(s,[],o,e)})},keys:function(t){var n=this.lambda(t),r=this,i="SELECT id FROM "+this.name+" ORDER BY timestamp DESC";return this.db.transaction(function(t){var s=function(e,t){if(t.rows.length==0)n.call(r,[]);else{var i=[];for(var s=0,o=t.rows.length;s<o;s++)i.push(t.rows.item(s).id);n.call(r,i)}};t.executeSql(i,[],s,e)}),this},save:function(n,r){var i=this,s=n.key||i.uuid(),o="INSERT INTO "+this.name+" (value, timestamp, id) VALUES (?,?,?)",u="UPDATE "+this.name+" SET value=?, timestamp=? WHERE id=?",a=function(){r&&(n.key=s,i.lambda(r).call(i,n))},f=[t(),s];return i.exists(n.key,function(t){i.db.transaction(function(r){var i=function(t){f.unshift(JSON.stringify(t)),r.executeSql(o,f,a,e)},s=function(t){delete t.key,f.unshift(JSON.stringify(t)),r.executeSql(u,f,a,e)};t?s(n):i(n)})}),this},batch:function(e,t){var n=[],r=!1,i=this,s=function(t){n.push(t),r=n.length===e.length},o=setInterval(function(){r&&(t&&i.lambda(t).call(i,n),clearInterval(o))},200);for(var u=0,a=e.length;u<a;u++)this.save(e[u],s);return this},get:function(t,n){var r=this,i="";this.isArray(t)?i="SELECT id, value FROM "+this.name+" WHERE id IN ('"+t.join("','")+"')":i="SELECT id, value FROM "+this.name+" WHERE id = '"+t+"'";var s=function(e,i){var s=null,o=[];if(i.rows.length)for(var u=0,a=i.rows.length;u<a;u++)s=JSON.parse(i.rows.item(u).value),s.key=i.rows.item(u).id,o.push(s);r.isArray(t)||(o=o.length?o[0]:null),n&&r.lambda(n).call(r,o)};return this.db.transaction(function(t){t.executeSql(i,[],s,e)}),this},exists:function(t,n){var r="SELECT * FROM "+this.name+" WHERE id = ?",i=this,s=function(e,t){n&&i.fn("exists",n).call(i,t.rows.length>0)};return this.db.transaction(function(n){n.executeSql(r,[t],s,e)}),this},all:function(t){var n=this,r="SELECT * FROM "+this.name,i=[],s=this.fn(this.name,t)||undefined,o=function(e,t){if(t.rows.length!=0)for(var r=0,o=t.rows.length;r<o;r++){var u=JSON.parse(t.rows.item(r).value);u.key=t.rows.item(r).id,i.push(u)}s&&s.call(n,i)};return this.db.transaction(function(t){t.executeSql(r,[],o,e)}),this},remove:function(t,n){var r=this,i=typeof t=="string"?t:t.key,s="DELETE FROM "+this.name+" WHERE id = ?",o=function(){n&&r.lambda(n).call(r)};return this.db.transaction(function(t){t.executeSql(s,[i],o,e)}),this},nuke:function(t){var n="DELETE FROM "+this.name,r=this,i=t?function(){r.lambda(t).call(r)}:function(){};return this.db.transaction(function(t){t.executeSql(n,[],i,e)}),this}}}()),window.LawnchairIEUserdata=Lawnchair.adapter("ie-userdata",{valid:function(){return typeof document.body.addBehavior!="undefined"},init:function(){var e=document.createElement("span");e.style.behavior="url('#default#userData')",e.style.position="absolute",e.style.left=1e4,document.body.appendChild(e),this.storage=e,this.storage.load("lawnchair")},get:function(e,t){var n=JSON.parse(this.storage.getAttribute(e)||"null");n&&(n.key=e),t&&t(n)},save:function(e,t){var n=e.key||"lc"+this.uuid();delete e.key,this.storage.setAttribute(n,JSON.stringify(e)),this.storage.save("lawnchair"),t&&(e.key=n,t(e))},all:function(e){var t=this.terseToVerboseCallback(e),n=this.storage.XMLDocument.firstChild.attributes,r=[],i,s;for(var o=0,u=n.length;o<u;o++)i=n[o],s=JSON.parse(i.nodeValue||"null"),s&&(s.key=i.nodeName,r.push(s));t&&t(r)},remove:function(e,t){var n=typeof e=="string"?e:e.key;this.storage.removeAttribute(n),this.storage.save("lawnchair"),t&&t()},nuke:function(e){var t=this;this.all(function(n){for(var r=0,i=n.length;r<i;r++)n[r].key&&t.remove(n[r].key);e&&e()})}}),Lawnchair.plugin({count:function(e,t){[].slice.call(arguments).length===1&&(t=e,e="key");var n=0;this.each(function(t){t[e]&&n++}),this.fn("count",t).call(this,n)},sum:function(e,t){var n=0;this.each(function(t){t[e]&&(n+=t[e])}),this.fn("sum",t).call(this,n)},avg:function(e,t){this.sum(e,function(n){this.count(e,function(e){this.fn("avg",t).call(this,n/e)})})},min:function(e,t){this._minOrMax("min",e,t)},max:function(e,t){this._minOrMax("max",e,t)},_minOrMax:function(e,t,n){var r,i;this.all(function(n){i=n.map(function(e){return e[t]}),r=Math[e].apply(Math,i)}),this.fn(e,n).call(this,r)}}),Lawnchair.plugin(function(){var e="save batch get remove nuke".split(" "),t={before:{},after:{}};for(var n=0,r=e.length;n<r;n++)t.before[e[n]]=[],t.after[e[n]]=[];return{init:function(){for(var t=0,n=e.length;t<n;t++)this.evented(e[t])},evented:function(e){var t=this[e],n=this;this[e]=function(){var r=[].slice.call(arguments),i=r[0],s=r[r.length-1],o=!1;this.fire("before",e,i),typeof s=="function"&&(r[r.length-1]=function(t){s.call(n,t),n.fire("after",e,t)},o=!0),t.apply(n,r),o||n.fire("after",e,i)}},fire:function(e,n,r){var i=t[e][n];for(var s=0,o=i.length;s<o;s++)i[s].call(this,r)},clearBefore:function(e){t.before[e]=[]},clearAfter:function(e){t.after[e]=[]},before:function(e,n){t.before[e].push(n)},after:function(e,n){t.after[e].push(n)}}}()),Lawnchair.plugin({page:function(e,t){var n=[],r=5,i=~~e||1,s=i+1,o=i-1,u=i==1?0:o*r,a=u>=r?u+r:r;this.all(function(e){n=e});var f=Math.ceil(n.length/r),e={max:f,next:s>f?f:s,prev:o==0?1:o};return this.__results=e[this.name]=n.slice(u,a),t&&this.fn("page",t).call(this,e),this}}),Lawnchair.plugin(function(){var e=function(e,t){var n=e.split("?").filter(function(e){return e!=""}),r="";for(var i=0,s=n.length;i<s;i++)r+=n[i]+t[i];return r},t=function(e){return function(t,n){return t[e]<n[e]?-1:t[e]>n[e]?1:0}};return{where:function(){var t=[].slice.call(arguments),n=t.shift(),r=t[t.length-1],i=n.match(/\?/g),s=i&&i.length>0?e(n,t.slice(0,i.length)):n,o=new Function(this.record,"return !!("+s+")"),u=[],a;return this.all(function(e){for(var t=0,n=e.length;t<n;t++)o(e[t])&&u.push(e[t])}),this.__results=u,t.length===1&&this.fn(this.name,r).call(this,this.__results),this},asc:function(e,n){return this.fn(this.name,n).call(this,this.__results.sort(t(e))),this},desc:function(e,n){return this.fn(this.name,n).call(this,this.__results.sort(t(e)).reverse()),this}}}());